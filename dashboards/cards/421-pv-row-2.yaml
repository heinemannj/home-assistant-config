type: custom:layout-card
layout_type: custom:grid-layout
cards:
  - type: custom:power-flow-card-plus
    title: Power Flows (Now)
    min_flow_rate: 0.75
    max_flow_rate: 6
    watt_threshold: 9999
    kw_decimals: 3
    w_decimals: 0
    clickable_entities: true
    display_zero_lines: true
    use_new_flow_rate_model: true
    entities:
      home:
        entity: sensor.house_consumption_power
        override_state: true
      solar:
        entity: sensor.inverter_input_power
      battery:
        entity: sensor.battery_charge_discharge_power_with_loss
        state_of_charge: sensor.battery_state_of_capacity
        color_circle: true
      grid:
        entity: sensor.power_meter_active_power
      fossil_fuel_percentage:
        entity: sensor.co2_signal_grid_fossil_fuel_percentage
        icon: mdi:pine-tree
        color_icon: true
        display_zero: true
        name: Low-carbon
        state_type: power
    inverted_entities: grid,battery
    card_mod: !include /config/custom_templates/power-flow-card-mod.yaml
  - type: vertical-stack
    cards:
      - type: horizontal-stack
        cards:
          - type: gauge
            entity: sensor.inverter_input_power
            name: Solar Power
            min: 0
            max: 9000
            needle: true
            segments:
              - from: 0
                color: red
              - from: 350
                color: orange
              - from: 700
                color: yellow
              - from: 2100
                color: green
            card_mod: !include /config/custom_templates/gauge-card-mod.yaml
          - type: gauge
            entity: sensor.battery_state_of_capacity
            name: Battery Capacity
            min: 0
            max: 100
            needle: true
            segments:
              - from: 0
                color: red
              - from: 3
                color: orange
              - from: 24
                color: yellow
              - from: 72
                color: green
            card_mod: !include /config/custom_templates/gauge-card-mod.yaml
          - type: custom:vertical-stack-in-card
            cards:
              - type: custom:mushroom-template-card
                primary: >-
                  {{ states('sensor.battery_state_of_capacity_remaining_charge_time') }}
                icon: mdi:battery-arrow-up
                entity: sensor.battery_state_of_capacity_remaining_charge_time
                secondary: ""
                tap_action:
                  action: more-info
                icon_color: "#f06292"
                card_mod: !include /config/custom_templates/421-pv-row-2-mushroom-card-mod-1.yaml
              - type: custom:mushroom-template-card
                primary: >-
                  {{ states('number.battery_maximum_charging_power') }} W
                icon: mdi:battery-arrow-up
                entity: number.battery_maximum_charging_power
                secondary: ""
                tap_action:
                  action: more-info
                icon_color: "#f06292"
                card_mod: !include /config/custom_templates/421-pv-row-2-mushroom-card-mod.yaml
              - type: custom:mushroom-template-card
                primary: >-
                  {{ states('sensor.battery_state_of_capacity_energy')|round(2) }} kWh
                icon: mdi:battery-high
                entity: sensor.battery_state_of_capacity_energy
                secondary: ""
                tap_action:
                  action: more-info
                icon_color: "#f06292"
                card_mod: !include /config/custom_templates/421-pv-row-2-mushroom-card-mod.yaml
              - type: custom:mushroom-template-card
                primary: >-
                  {{ states('sensor.battery_state_of_capacity_remaining_discharge_time') }}
                icon: mdi:battery-arrow-down
                entity: >-
                  sensor.battery_state_of_capacity_remaining_discharge_time
                secondary: ""
                tap_action:
                  action: more-info
                icon_color: "#4db6ac"
                card_mod: !include /config/custom_templates/421-pv-row-2-mushroom-card-mod.yaml
            card_mod: !include /config/custom_templates/421-pv-row-2-vertical-stack-in-card-mod.yaml
          - type: gauge
            entity: sensor.house_self_sufficiency_daily
            name: Self Sufficiency
            min: 0
            max: 100
            needle: true
            segments:
              - from: 0
                color: red
              - from: 65
                color: orange
              - from: 75
                color: yellow
              - from: 85
                color: green
            card_mod: !include /config/custom_templates/gauge-card-mod.yaml
          - type: gauge
            entity: sensor.inverter_internal_temperature
            name: Inverter Temp.
            min: 20
            max: 70
            needle: true
            segments:
              - from: 20
                color: green
              - from: 45
                color: yellow
              - from: 60
                color: orange
              - from: 65
                color: red
            card_mod: !include /config/custom_templates/gauge-card-mod.yaml
          - type: custom:vertical-stack-in-card
            cards:
              - type: custom:mushroom-template-card
                primary: >-
                  {{ states('sensor.house_consumption_energy_daily_control')|round(2) }} kWh
                icon: mdi:home-lightning-bolt
                entity: sensor.house_consumption_energy_daily_control
                secondary: ""
                tap_action:
                  action: more-info
                icon_color: "#66CDAA"
                card_mod: !include /config/custom_templates/421-pv-row-2-mushroom-card-mod-1.yaml
              - type: custom:mushroom-template-card
                primary: "{{ states('fan.xiaomi_smart_fan') }}"
                icon: mdi:fan
                entity: fan.xiaomi_smart_fan
                secondary: ""
                tap_action:
                  action: more-info
                icon_color: "#ff9800"
                card_mod: !include /config/custom_templates/421-pv-row-2-mushroom-card-mod.yaml
            card_mod: !include /config/custom_templates/421-pv-row-2-vertical-stack-in-card-mod.yaml
        card_mod:
          style: |
            ha-card {
              width: 915px !important;
              height: 100px !important;
              }
      - type: custom:apexcharts-card
        header:
          show: true
          standard_format: true
          show_states: true
          colorize_states: true
        apex_config:
          chart:
            height: 220px
          tooltip:
            enabled: true
            shared: true
            followCursor: true
        graph_span: 4d
        now:
          show: false
          color: grey
          label: Now
        span:
          start: day
          offset: "-1day"
        all_series_config:
          type: area
          opacity: 0.3
          stroke_width: 1
        series:
          - entity: sensor.battery_state_of_capacity
            name: Battery
            float_precision: 0
            type: line
            color: "#f06292"
            opacity: 0.6
            yaxis_id: capacity
            extend_to: now
            show:
              legend_value: true
              in_header: false
            group_by:
              func: last
              duration: 5m
          - entity: sensor.house_consumption_power
            name: House Power
            float_precision: 3
            type: line
            color: MediumAquaMarine
            opacity: 0.8
            yaxis_id: kWh
            unit: kW
            transform: return x/1000;
            extend_to: now
            show:
              legend_value: true
              in_header: false
            group_by:
              func: avg
              duration: 5m
          - entity: sensor.inverter_input_power
            name: Solar Power
            float_precision: 3
            color: "#ff9800"
            yaxis_id: kWh
            unit: kW
            transform: return x/1000;
            extend_to: now
            show:
              legend_value: true
              in_header: false
            group_by:
              func: avg
              duration: 5m
          - entity: sensor.solcast_forecast_today
            name: Solar Forecast (D1)
            extend_to: false
            color: grey
            opacity: 0.3
            stroke_width: 0
            yaxis_id: kWh
            show:
              legend_value: false
              in_header: false
            data_generator: |
              return entity.attributes.forecast.map((entry) => {
                    return [new Date(entry.period_start), entry.pv_estimate];
                  });
          - entity: sensor.solcast_forecast_tomorrow
            name: Solar Forecast (D2)
            float_precision: 3
            extend_to: false
            color: grey
            opacity: 0.3
            stroke_width: 0
            yaxis_id: kWh
            show:
              legend_value: false
              in_header: false
            data_generator: |
              return entity.attributes.forecast.map((entry) => {
                    return [new Date(entry.period_start), entry.pv_estimate];
                  });
          - entity: sensor.solcast_forecast_d3
            name: Solar Forecast (D3)
            float_precision: 3
            extend_to: false
            color: grey
            opacity: 0.3
            stroke_width: 0
            yaxis_id: kWh
            show:
              legend_value: false
              in_header: false
            data_generator: |
              return entity.attributes.forecast.map((entry) => {
                    return [new Date(entry.period_start), entry.pv_estimate];
                  });
          - entity: sensor.solcast_forecast_today
            yaxis_id: header_only
            name: Solar Forecast (D1)
            color: grey
            show:
              legend_value: true
              in_header: true
              in_chart: false
          - entity: sensor.solcast_forecast_remaining_today_every_minute
            yaxis_id: header_only
            name: Forecast (D1 Remaining)
            color: grey
            show:
              legend_value: true
              in_header: true
              in_chart: false
          - entity: sensor.solcast_forecast_tomorrow
            yaxis_id: header_only
            name: Forecast (D2)
            color: grey
            show:
              legend_value: true
              in_header: true
              in_chart: false
          - entity: sensor.solcast_forecast_d3
            yaxis_id: header_only
            name: Solar Forecast (D3)
            color: grey
            show:
              legend_value: true
              in_header: true
              in_chart: false
          - entity: sensor.solcast_api_last_polled
            yaxis_id: header_only
            name: Forecast (Last Update)
            color: grey
            unit: " min."
            transform: >-
              return ((Date.now()) - (new Date(x).getTime())) / 60 / 60 / 24
            show:
              legend_value: true
              in_header: true
              in_chart: false
        yaxis:
          - id: capacity
            show: true
            opposite: true
            decimals: 0
            max: 100
            min: 0
            apex_config:
              tickAmount: 5
          - id: kWh
            show: true
            min: 0
            apex_config:
              tickAmount: 5
          - id: header_only
            show: false
        card_mod:
          style: |
            ha-card {
              width: 915px !important;
              height: 270px !important;
            }
            #header {
                padding-top: 10px !important;
                line-height: 1.0em !important;
            }
            #state__value > #state {
                font-size: 1.0em !important;
            }
            #state__value > #uom {
                font-size: 0.6em !important;
            }
  - type: custom:energy-flow-card-plus
    title: Energy Flows (Today)
    min_flow_rate: 3
    max_flow_rate: 10
    wh_kwh_threshold: 0
    kwh_decimals: 2
    wh_decimals: 2
    energy_date_selection: false
    clickable_entities: true
    entities:
      home:
        entity: sensor.house_consumption_energy_daily
        override_state: false
      solar:
        entity: sensor.solar_yield_daily
      battery:
        entity:
          consumption: sensor.battery_day_discharge_with_loss
          production: sensor.battery_day_charge_with_loss
        state_of_charge: sensor.battery_state_of_capacity
        color_circle: true
      grid:
        entity:
          consumption: sensor.power_meter_consumption_energy_daily
          production: sensor.power_meter_exported_energy_daily
      fossil_fuel_percentage:
        entity: sensor.co2_signal_grid_fossil_fuel_percentage
        icon: mdi:pine-tree
        color_icon: true
        display_zero: true
        name: Low-carbon
        state_type: kWh
    card_mod: !include /config/custom_templates/power-flow-card-mod.yaml
layout:
  grid-template-columns: 365px 920px 365px
  margin: 0px;
  padding: 0px;
